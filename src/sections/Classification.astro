---
interface Rider {
    number: string;
    name: string;
    team: string;
    points: number;
    color: string;
}

const imageNotFound = false;

const fetchClassification = async () => {
    try {
        const response = await fetch(
            "https://mototiming.live/api/stat/standings-stats?class=MotoGP",
        );
        if (!response.ok) {
            throw new Error(
                `Network response was not ok: ${response.statusText}`,
            );
        }
        const standings_data = await response.json();
        return standings_data.data.find(
            (r: any) => r.race.name == standings_data.last_race,
        );
    } catch (error) {
        console.error("Error fetching events:", error);
        return null;
    }
};

const classification = await fetchClassification();

let standings: Rider[] = [];

if (classification) {
    standings = classification.ranking
        .map((rider_number: string) => {
            const rider: any = Object.values(classification.riders).find(
                (r: any) => r.number === rider_number,
            );
            return rider
                ? {
                      number: rider.number,
                      name: rider.name,
                      team: rider.team,
                      points: rider.season.points.total,
                      color: rider.color,
                  }
                : null;
        })
        .filter((rider: any): rider is Rider => rider !== null);
}

// Function to determine if the text color should be red or black
const getTextColor = (backgroundColor: string) => {
    if(backgroundColor == null) return 'text-black';
  const hex = backgroundColor.replace('#', '');
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 128 ? 'text-black' : 'text-white';
};

const errorImageNotFound = (
    event: Event,
    image: HTMLImageElement,
    imageNotFound: boolean,
) => {
    imageNotFound = true;
    image.style.display = 'none';
    console.error('Image not found');
    return imageNotFound;

};

---
<section class="bg-white pt-10 md:mx-20">
    <div class="text-center text-2xl font-bold pb-5">MotoGP Standings</div>
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="text-center py-3 text-xs font-medium text-gray-500 uppercase tracking-wider" >Pos </th>
            <th class="py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" style="width:3%"> Number</th>
            <th class="py-3 pl-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
            <th class="py-3 pl-7 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
            <th class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Team</th>
            <th class="pr-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Points</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {standings.map((rider,index) => (
            <tr id={rider.number} class="hover:bg-gray-100">
              <td class="py-4 whitespace-nowrap md:text-xl text-center text-sm font-medium text-gray-900">{index + 1}</td>
              <td class="py-2 h-14 w-5 sm:w-10 whitespace-nowrap text-center text-sm font-medium text-gray-900">
                <div class={`w-10 md:w-14 text-xl md:text-2xl lg:text-3xl h-full flex font-black items-center justify-center rounded ${getTextColor(rider.color)}`} style={`background-color: ${rider.color}`}>
                  {rider.number}
                </div>
            </td>
            {imageNotFound ? (
              <p>No image found with the given prefix</p>
              ) : (
              <td class="w-5 whitespace-nowrap text-base md:text-xl font-bold text-gray-500">
                <div class="w-10 lg:w-20 max-h-28 max-w-xs overflow-hidden relative">
                  <img class="object-cover transform image-translate" src={`/assets/riders/${rider.number}.png`} onerror="this.hide">
                </div>
                </td>
            )}
              <td class="sm:pl-7 py-4 whitespace-nowrap text-base md:text-xl font-bold text-gray-500">{rider.name}</td>
              <td class="py-4 whitespace-nowrap text-xl text-gray-400 hidden lg:table-cell">{rider.team}</td>
              <td class="py-4 whitespace-nowrap text-center md:text-xl text-gray-500 font-black">{rider.points}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
</section>
<style>

        .image-translate {
            transform-origin: top center;
            transform: scale(2);
        }

    </style>
